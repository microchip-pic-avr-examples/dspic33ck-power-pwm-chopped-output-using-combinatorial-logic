<<<<<<< HEAD
pipeline {
    agent {
        kubernetes {
            label 'github_deployment'
			defaultContainer 'xc16-mplabx-sonar-fmpp-python'
=======
/*
    Jenkins Shared Library:
    ----------------------
    shared-library-mcu16ce - https://bitbucket.microchip.com/scm/citd/shared-library-mcu16ce.git
    shared-library-common - https://bitbucket.microchip.com/scm/citd/shared-library-common.git    
*/
@Library(['shared-library-mcu16ce@develop', 'shared-library-common@develop']) _

pipeline {
    agent {
        kubernetes {
            label 'dspic33ck-power-pwm-chopped-output-using-combinatorial-logic-github-deployment'
            defaultContainer 'xc16-mplabx-sonar-fmpp-python'
>>>>>>> 0f84ba9bf6b00f5dc3b3194b14e27c5b7a05c69a
            yamlFile '.citd/cloudprovider.yml'
        }
    }
   
<<<<<<< HEAD

	environment {
	    NOTIFICATION_EMAIL = '1f1319de.microchip.com@amer.teams.ms'	
		//Branch to be deployed, if multiple branches use comma separated string
		//This is the BitBucket source repo URL to be deployed
		BITBUCKET_SOURCE_URL = 'https://bitbucket.microchip.com/scm/mcu16ce/dspic33ck-power-pwm-push-pull.git'
		BITBUCKET_CREDENTIAL_ID = 'BITBUCKET_INTERNAL_TOKEN'
		GITHUB_PRODUCTION_DEPLOY_URL ='https://github.com/microchip-pic-avr-examples'
		GITHUB_TEST_DEPLOY_URL ='https://github.com/mchpTestArea'
		//Selects the deployment URL(production or test) based on the merge target branch, selects "microchip-pic-avr-examples" if target branch is "master" , if target branch is "test_deploy" selects "mchpTestArea" else null
		GITHUB_URL = getGitHubUrl("${GITHUB_PRODUCTION_DEPLOY_URL}","${GITHUB_TEST_DEPLOY_URL}")
		GITHUB_PRODUCTION_DEPLOY_CREDENTIAL_ID ='GITHUB_MICROCHIP_PIC_AVR_EXAMPLES_TOKEN'
		GITHUB_TEST_DEPLOY_CREDENTIAL_ID ='GITHUB_PIC_AVR_TEST_TOKEN'
		//Gets the Github credential id based on the deployment organization
	    GITHUB_CREDENTIAL_ID = getGitHubCredentialId("${GITHUB_URL}","${GITHUB_PRODUCTION_DEPLOY_URL}","${GITHUB_TEST_DEPLOY_URL}","${GITHUB_PRODUCTION_DEPLOY_CREDENTIAL_ID}","${GITHUB_TEST_DEPLOY_CREDENTIAL_ID}")
		//Files or folders to be excluded from deployment, if multiple files or folders use comma separator
		DEPLOY_EXCLUDE_FOLDER_FILE_LIST = 'mchp_private'
		//Branch(s) to be deployed, if multiple branches use comma separator. ${env.BRANCH_NAME} is the target branch of the PR.
		DEPLOY_BRANCH_LIST = "${env.BRANCH_NAME}"
		CHANGE_LOG_PATH = 'changelog.md'
		SOURCE_PROJECT_META_DATA = '.main-meta/main.json'
		DEPLOY_TOOL_URL = 'https://bitbucket.microchip.com/scm/citd/tool-github-deploy.git'
	}
=======
    environment {
        /*
            Common Information
        */
        NOTIFICATION_EMAIL = '1f1319de.microchip.com@amer.teams.ms'  
        // GitHub production organization name
        GITHUB_PRODUCTION_ORGANIZATION = "microchip-pic-avr-examples"
        
        /*
            GitHub Deploy Stage Information
        */
        //This is the BitBucket source repo URL to be deployed
        BITBUCKET_SOURCE_URL = https://bitbucket.microchip.com/scm/mcu16ce/dspic33ck-power-pwm-chopped-output-using-combinatorial-logic.git'  
        //Files or folders to be excluded from deployment, if multiple files or folders use comma separator
        DEPLOY_EXCLUDE_FOLDER_FILE_LIST = 'mchp_private'
        //Branch(s) to be deployed, if multiple branches use comma separator. ${env.BRANCH_NAME} is the target branch of the PR.
        DEPLOY_BRANCH_LIST = "${env.BRANCH_NAME}"
        
        /*
            GitHub Release Stage Information
        */
        CHANGE_LOG_PATH = 'changelog.md'
        
        /*
            Bitbucket Tag Creation Stage Information
        */
        BITBUCKET_PROJECT_NAME = 'MCU16CE'
        
        /*
            GitHub Page Stage Information
            List of GitHub Page Options:
            ----------------------------
            1. GITHUB_PAGES_NONE         ( Branch: None, index file path: None )
            2. GITHUB_PAGES_MASTER_ROOT  ( Branch: Master, index file path: /root )
            3. GITHUB_PAGES_MASTER_DOCS  ( Branch: Develop, index file path: /Docs ) 
            4. GITHUB_PAGES_DEVELOP_ROOT ( Branch: Master, index file path: /root )
            5. GITHUB_PAGES_DEVELOP_DOCS ( Branch: Develop, index file path: /Docs )
        */
        GITHUB_PAGES = 'GITHUB_PAGES_MASTER_ROOT'    

        /*
            Project Build Stage Information
        */
        MPLABX_PROJECT_SOURCE = "../"
        
        /*
            Json Schema validator Stage Information
        */
        JSON_SCHEMA_FILE_PATH = "tool-github-deploy/tool-github-deploy/json/json_schema.json"
    }
>>>>>>> 0f84ba9bf6b00f5dc3b3194b14e27c5b7a05c69a

    options {
        timestamps()
        timeout(time: 20, unit: 'MINUTES')
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }
<<<<<<< HEAD

        stage('Build') {
            steps {
                script {
                   execute("git clone https://bitbucket.microchip.com/scm/citd/tool-mplabx-c-build.git")
                   execute("cd ./tool-mplabx-c-build && node buildLauncher.js sp=../ rp=./output genMK=true")
               }
            }
        }
	   
	    // Cloning the tool used for GitHub deployment
	   	stage('GitHub tool clone'){
			when {
                    anyOf {
                        allOf {
                            not { changeRequest() }
                            anyOf {branch 'master'; branch 'test_deploy';}
                        }
                    }
            }
            steps{
               script{
                    execute("git clone https://bitbucket.microchip.com/scm/citd/tool-github-deploy.git")
                    execute("chmod +x ./tool-github-deploy/tool-github-deploy/tool-github-deploy.py")                    
                }
            }
        } 
		
		// Creating tag in Bitbucket repo
	   	stage('Bitbucket Tag Creation'){
			when {
=======
        
        stage('project config update') {
            steps {
                script {                    
                    mplabxProjectConfigUpdate(
                        sourceFilePath: "${env.MPLABX_PROJECT_SOURCE}"
                    )
                }
            }
        }
        
        stage('Build') {
            steps {
                script {                   
                    mplabxProjectBuild(
                        sourceFilePath: "${env.MPLABX_PROJECT_SOURCE}"
                    )
               }
            }
        }
        
        // Validate main.json file
           stage('Validate main.json'){            
            steps{
               script{                    
                    validateMetaData(
                        jsonSchemaFilePath: "${env.JSON_SCHEMA_FILE_PATH}"
                    )                   
                }
            }
        } 
        
        // Creating tag in Bitbucket repo
           stage('Bitbucket Tag Creation') {
            when {
>>>>>>> 0f84ba9bf6b00f5dc3b3194b14e27c5b7a05c69a
                    anyOf {
                        allOf {
                            not { changeRequest() }
                            anyOf {branch 'master';}
                        }
                    }
            }
            steps{
               script{
<<<<<<< HEAD
                    def jsonObj = readJsonObject();
                    
                    withCredentials([usernamePassword(credentialsId: "${env.BITBUCKET_CREDENTIAL_ID}", passwordVariable: 'PASS', usernameVariable: 'USER_NAME')]) {
                        execute("python tool-github-deploy/tool-github-deploy/tool-github-deploy.py -bto=true -rpn=\"${jsonObj.content.projectName}\" -bid=$USER_NAME -bpat=$PASS -bpn=MCU16CE -btv=\"${jsonObj.content.version}\" -bch=${env.GIT_COMMIT} -btd=\"${jsonObj.content.version}\"")
                    }
                }
            }
        }
		
	    // GitHub repo creation 
	    stage('GitHub Repo Creation'){
			when {
=======
                    bitbucketTagCreation(
                        projectName: "${env.BITBUCKET_PROJECT_NAME}",
                        commitId: "${env.GIT_COMMIT}"
                    )
                }
            }
        }
        
        // GitHub repo creation 
        stage('GitHub Repo Creation'){
            when {
>>>>>>> 0f84ba9bf6b00f5dc3b3194b14e27c5b7a05c69a
                    anyOf {
                        allOf {
                            not { changeRequest() }
                            anyOf {branch 'master'; branch 'test_deploy';}
                        }
                    }
            }
            steps{
                script{
<<<<<<< HEAD
                    def jsonObj = readJsonObject();
                    
                    String [] topics = jsonObj.content.keywords
                    def asString = topics.join(", ")
					Boolean visibility =  true
					if(env.GITHUB_URL == env.GITHUB_PRODUCTION_DEPLOY_URL)
					{
					   visibility = false
					}
                    
                    withCredentials([usernamePassword(credentialsId: "${env.GITHUB_CREDENTIAL_ID}", passwordVariable: 'PASS', usernameVariable: 'USER_NAME')]) {
                        execute("python tool-github-deploy/tool-github-deploy/tool-github-deploy.py -rpo=true -gpat=$PASS -rporg=${env.GITHUB_URL} -rpn=${jsonObj.content.projectName} -rpd=\"${jsonObj.content.shortDescription}\" -rpt=\"${asString}\" -rpp=${visibility}")
                    }
                }
            }
        } 
	
	    // Deploying the code to GitHub 
		stage('GitHub Deploy Source'){
			when {
=======
                    githubRepoCreate(
                         githubOrgName : "${env.GITHUB_PRODUCTION_ORGANIZATION}"
                    )
                }
            }
        } 

        // Deploying the code to GitHub 
        stage('GitHub Deploy Source'){
            when {
>>>>>>> 0f84ba9bf6b00f5dc3b3194b14e27c5b7a05c69a
                    anyOf {
                        allOf {
                            not { changeRequest() }
                            anyOf {branch 'master'; branch 'test_deploy';}
                        }
                    }
            }
            steps{
                script{
<<<<<<< HEAD
                    def jsonObj = readJsonObject();
                    def gitHubUrl = "${env.GITHUB_URL}" + "/" + jsonObj.content.projectName
                    gitHubUrl = gitHubUrl.replace(" ", "").replace("\n", "")
                    
                    withCredentials([usernamePassword(credentialsId: "${env.GITHUB_CREDENTIAL_ID}", passwordVariable: 'PASS', usernameVariable: 'USER_NAME')]) {
                        execute("python tool-github-deploy/tool-github-deploy/tool-github-deploy.py -deploy=true -gpat=$PASS -dgid=$USER_NAME -dburl=${env.BITBUCKET_SOURCE_URL} -dgurl=${gitHubUrl}  -dbranch=${env.DEPLOY_BRANCH_LIST} -def=${env.DEPLOY_EXCLUDE_FOLDER_FILE_LIST}")
                    }
                }
            }
        }
		
		// Creating GitHub release  
		stage('GitHub release'){
			when {
=======
                
                    githubDeploySource(
                        bitbucketUrl: "${env.BITBUCKET_SOURCE_URL}",
                        deployBranchList: "${env.DEPLOY_BRANCH_LIST}",
                        deployExcludeFileList: "${env.DEPLOY_EXCLUDE_FOLDER_FILE_LIST}",
                        githubOrgName: "${env.GITHUB_PRODUCTION_ORGANIZATION}"
                    )
                }
            }
        }
        
        // Creating GitHub release  
        stage('GitHub release'){
            when {
>>>>>>> 0f84ba9bf6b00f5dc3b3194b14e27c5b7a05c69a
                    anyOf {
                        allOf {
                            not { changeRequest() }
                            anyOf {branch 'master'; branch 'test_deploy';}
                        }
                    }
            }
<<<<<<< HEAD
            steps{
               script{
                    def jsonObj = readJsonObject();
                    
                    withCredentials([usernamePassword(credentialsId: "${env.GITHUB_CREDENTIAL_ID}", passwordVariable: 'PASS', usernameVariable: 'USER_NAME')]) {
                        execute("python tool-github-deploy/tool-github-deploy/tool-github-deploy.py -rlo=true -gpat=$PASS -rporg=${env.GITHUB_URL} -rpn=\"${jsonObj.content.projectName}\" -rltv=\"${jsonObj.content.version}\" -rltt=\"${jsonObj.content.version}\" -rlnp=${env.CHANGE_LOG_PATH}")
                    }
                }
            }
        }
		
		//Deploying the Github content to portal
		stage('Portal-Deploy') {
			when {
				allOf {
                    not { changeRequest() }
                    anyOf {branch 'master';}
                }
			}
			steps {
				script {
					def jsonObj = readJsonObject();			
					def version = jsonObj.content.version
					def project = jsonObj.content.projectName
					
                    String[] splitPreTag = "${env.GITHUB_URL}".split("/")
                    def gitHubOrg = (splitPreTag[splitPreTag.size() - 1])

					def cmdArgs = "'{\"repoOwnerName\":\"$gitHubOrg\",\"repoName\":\"$project\",\"tagName\":\"$version\"}'"
					cmdArgs = cmdArgs.replaceAll("\"","\\\\\"")						
					
					execute("git clone https://bitbucket.microchip.com/scm/portal/bundles.git")
					execute("cd bundles && chmod 755 ./portal-client-cli-linux")
					execute("git clone https://bitbucket.microchip.com/scm/citd/tool-portal-client-launcher.git")
					execute("cd tool-portal-client-launcher && node portalLauncher.js -app=../bundles/portal-client-cli-linux -cmd=\"uploadGitHub ${cmdArgs}\"")
				}
			}
		}
        
=======
            
            steps{
               script{
                    githubReleaseCreate(
                        changeLogFilePath: "${env.CHANGE_LOG_PATH}",
                        githubOrgName: "${env.GITHUB_PRODUCTION_ORGANIZATION}"                        
                    )
                }
            }
        }
        
        // Creating GitHub Page  
        stage('GitHub Page Create'){
            when {
                    anyOf {
                        allOf {
                            not { changeRequest() }
                            anyOf {branch 'master'; branch 'test_deploy';}
                        }
                    }
            }
            
            steps{
               script{
                    githubPageCreate(
                        githubPage: "${env.GITHUB_PAGES}",
                        githubOrgName: "${env.GITHUB_PRODUCTION_ORGANIZATION}"
                    )
                }
            }
        }
        
        //Deploying the Github content to portal
        stage('Portal-Deploy') {
            when {
                allOf {
                    not { changeRequest() }
                    anyOf {branch 'master';}
                }
            }
            steps {
                script {
                    portalDeploy(
                        githubOrgName: "${env.GITHUB_PRODUCTION_ORGANIZATION}"
                    )
                }
            }
        }
>>>>>>> 0f84ba9bf6b00f5dc3b3194b14e27c5b7a05c69a
      }

    post {
        success{
            script {
<<<<<<< HEAD
                if (!"${env.CHANGE_AUTHOR_EMAIL}".equalsIgnoreCase("null")) {
				    archiveArtifacts artifacts: "tool-mplabx-c-build/output/**", fingerprint: true
                    mail to: "${env.CHANGE_AUTHOR_EMAIL}, ${env.NOTIFICATION_EMAIL}",
                    subject: "Successful Pipeline: ${currentBuild.fullDisplayName}",
                    body: "Something is right with ${env.BUILD_URL}"
                } else {
				    archiveArtifacts artifacts: "tool-mplabx-c-build/output/**", fingerprint: true
                    mail to: "${env.NOTIFICATION_EMAIL}",
                    subject: "Successful Pipeline: ${currentBuild.fullDisplayName}",
                    body: "Something is right with ${env.BUILD_URL}"
                }
=======
                sendMail(
                    mailId: "${env.NOTIFICATION_EMAIL}",
                    subject: "Successful Pipeline: ${currentBuild.fullDisplayName}",
                    body: "Something is right with ${env.BUILD_URL}"
                )
>>>>>>> 0f84ba9bf6b00f5dc3b3194b14e27c5b7a05c69a
            }
        }
        failure {
            script {
<<<<<<< HEAD
                if (!"${env.CHANGE_AUTHOR_EMAIL}".equalsIgnoreCase("null")) {
				    archiveArtifacts artifacts: "tool-mplabx-c-build/output/**", fingerprint: true
                    mail to: "${env.CHANGE_AUTHOR_EMAIL}, ${env.NOTIFICATION_EMAIL}",
                    subject: "Failed Pipeline: ${currentBuild.fullDisplayName}",
                    body: "Pipeline failure. ${env.BUILD_URL}"
                } else {
				    archiveArtifacts artifacts: "tool-mplabx-c-build/output/**", fingerprint: true
                    mail to: "${env.NOTIFICATION_EMAIL}",
                    subject: "Failed Pipeline: ${currentBuild.fullDisplayName}",
                    body: "Pipeline failure. ${env.BUILD_URL}"
                }
=======
                sendMail(
                    mailId: "${env.NOTIFICATION_EMAIL}",
                    subject: "Failure Pipeline: ${currentBuild.fullDisplayName}",
                    body: "Something is right with ${env.BUILD_URL}"
                )
>>>>>>> 0f84ba9bf6b00f5dc3b3194b14e27c5b7a05c69a
            }
        }
    }
}
<<<<<<< HEAD

def execute(String command) {
    if (isUnix()) {
        sh command
    } else {
        bat command
    }
}

String readJsonObject() {
    def jsonObj  = readJSON interpolate: true, file: "${env.SOURCE_PROJECT_META_DATA}"
    return jsonObj
}
def getGitHubUrl(String productionUrl, String testDeployUrl) {
    String branchName = "${env.BRANCH_NAME}";
    if(branchName == 'master') {
        return productionUrl;
    } else if(branchName == 'test_deploy') {
        return testDeployUrl;
    } else {
        return null
    }
}
def getGitHubCredentialId(String deployUrl, String productionDeployUrl, String testDeployUrl, String githubProductionDeployCredential, String githubTestDeployCredential) {    
    if(deployUrl == productionDeployUrl) {
        return githubProductionDeployCredential;
    } else if(deployUrl == testDeployUrl) {
        return githubTestDeployCredential;
    } else {
        return null
    }
}
=======
>>>>>>> 0f84ba9bf6b00f5dc3b3194b14e27c5b7a05c69a
